name: {{ env.APP_NAME }}-ig
folder_id: {{ env.YC_FOLDER_ID }}
service_account_id: {{ env.YC_SERVICE_ACCOUNT_ID }}
description: Instance Group for {{ env.APP_NAME }}
instance_template:
  platform_id: standard-v2
  resources_spec:
    cores: 2
    memory: 4294967296
  boot_disk_spec:
    mode: READ_WRITE
    disk_spec:
      # Container Optimized Image (COI) - стандартный пользователь: yc-user
      image_id: fd846fg1abf9s6degc97
      type_id: network-hdd
      size: 21474836480
  network_interface_specs:
    - network_id: {{ env.YC_NETWORK_ID }}
      subnet_ids:
        - {{ env.YC_SUBNET_ID }}
      # Публичный IP для SSH доступа (опционально)
      # Раскомментируйте, если нужен публичный доступ:
      # primary_v4_address_spec:
      #   one_to_one_nat_spec:
      #     ip_version: IPV4
  # SSH ключи для доступа к инстансам
  # Формат: "username:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAB... user@host"
  # Для Container Optimized Image используется пользователь yc-user
  metadata:
    # SSH ключ для доступа к инстансам
    # Формат: "yc-user:{{ env.SSH_PUBLIC_KEY }}"
    # Убедитесь, что добавили SSH_PUBLIC_KEY в GitHub Secrets
    ssh-keys: "yc-user:{{ env.SSH_PUBLIC_KEY }}"
  labels:
    app: {{ env.APP_NAME }}
scale_policy:
  fixed_scale:
    size: 2
allocation_policy:
  zones:
    - zone_id: ru-central1-a
deploy_policy:
  max_unavailable: 1
  max_expansion: 1
  max_deleting: 1
  max_creating: 1
  startup_duration: 120s
health_checks_spec:
  health_check_specs:
    # HTTP health check (проверяет endpoint /health)
    - interval: 10s
      timeout: 5s
      unhealthy_threshold: 5
      healthy_threshold: 2
      http_options:
        port: 3333
        path: /health
    # Альтернативный TCP health check (просто проверяет, что порт открыт)
    # Раскомментируйте, если HTTP health check не работает:
    # - interval: 10s
    #   timeout: 5s
    #   unhealthy_threshold: 5
    #   healthy_threshold: 2
    #   tcp_options:
    #     port: 3333
  max_checking_health_duration: 120s

# Autohealing (автоматическое восстановление)
# Если инстанс помечен как unhealthy, он будет автоматически перезапущен или пересоздан
# Autohealing работает автоматически на основе health_checks_spec
# Дополнительная настройка не требуется - включено по умолчанию
