name: Deploy Frontend to Object Storage

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Frontend application name from apps/ directory (e.g., frontend)'
        required: true
        type: string
      bucket_name:
        description: 'Object Storage bucket name'
        required: false
        default: 'mv-dating'
        type: string
      version:
        description: 'Version tag (leave empty to use commit SHA, first 8 chars)'
        required: false
        default: ''
        type: string
      deploy_to_latest:
        description: 'Deploy to latest version (create/update latest symlink)'
        required: false
        default: true
        type: boolean
      build_command:
        description: 'Build command (default: npm run build)'
        required: false
        default: 'npm run build'
        type: string
      build_output:
        description: 'Build output directory (default: dist)'
        required: false
        default: 'dist'
        type: string

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Validate application exists
        run: |
          if [ ! -d "apps/${{ github.event.inputs.app_name }}" ]; then
            echo "âŒ Error: Application 'apps/${{ github.event.inputs.app_name }}' not found!"
            echo ""
            echo "Available applications:"
            ls -1 apps/ 2>/dev/null || echo "No apps directory found"
            exit 1
          fi
          
          echo "âœ… Application found: ${{ github.event.inputs.app_name }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¸Ğ· ĞºĞ¾Ñ€Ğ½Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° (Ğ´Ğ»Ñ monorepo)
          npm ci || npm install

      - name: Build frontend
        run: |
          cd apps/${{ github.event.inputs.app_name }}
          ${{ github.event.inputs.build_command }}
        env:
          NODE_ENV: production

      - name: Validate build output
        run: |
          BUILD_OUTPUT="${{ github.event.inputs.build_output }}"
          APP_DIR="apps/${{ github.event.inputs.app_name }}"
          
          if [ ! -d "$APP_DIR/$BUILD_OUTPUT" ]; then
            echo "âŒ Error: Build output directory '$BUILD_OUTPUT' not found in '$APP_DIR'"
            echo ""
            echo "Available directories:"
            ls -la "$APP_DIR" || echo "Directory not found"
            exit 1
          fi
          
          echo "âœ… Build output found: $APP_DIR/$BUILD_OUTPUT"

      - name: Build bucket name and version
        id: bucket
        run: |
          APP_NAME="${{ github.event.inputs.app_name }}"
          
          if [ -n "${{ github.event.inputs.bucket_name }}" ]; then
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ bucket
            BUCKET_NAME="${{ github.event.inputs.bucket_name }}"
          else
            # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ¼Ñ bucket: owner-reponame-appname
            REPO_OWNER="${{ github.repository_owner }}"
            REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
            BUCKET_NAME="${REPO_OWNER}-${REPO_NAME}-${APP_NAME}"
          fi
          
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ²ĞµÑ€ÑĞ¸Ñ
          if [ -z "${{ github.event.inputs.version }}" ]; then
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ SHA ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ° (Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 8 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)
            COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
            VERSION="$COMMIT_SHA"
          else
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ
            VERSION="${{ github.event.inputs.version }}"
          fi
          
          echo "name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸŒ Bucket name: $BUCKET_NAME"
          echo "ğŸ“¦ Version: $VERSION"

      - name: Upload files to versioned directory
        uses: yc-actions/yc-obj-storage-upload@v3
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
          bucket: ${{ steps.bucket.outputs.name }}
          root: apps/${{ github.event.inputs.app_name }}/${{ github.event.inputs.build_output }}
          prefix: v/${{ steps.bucket.outputs.version }}/
          include: |
            **/*
        
      - name: Deploy to latest version
        if: github.event.inputs.deploy_to_latest == true
        uses: yc-actions/yc-obj-storage-upload@v3
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
          bucket: ${{ steps.bucket.outputs.name }}
          root: apps/${{ github.event.inputs.app_name }}/${{ github.event.inputs.build_output }}
          prefix: v/latest/
          include: |
            **/*

      - name: Set bucket URLs
        id: bucket_url
        run: |
          BUCKET_NAME="${{ steps.bucket.outputs.name }}"
          VERSION="${{ steps.bucket.outputs.version }}"
          
          BASE_URL="https://storage.yandexcloud.net/$BUCKET_NAME"
          VERSION_URL="$BASE_URL/v/$VERSION"
          LATEST_URL="$BASE_URL/v/latest"
          
          echo "base_url=$BASE_URL" >> $GITHUB_OUTPUT
          echo "version_url=$VERSION_URL" >> $GITHUB_OUTPUT
          echo "latest_url=$LATEST_URL" >> $GITHUB_OUTPUT
          
          echo "ğŸŒ Base URL: $BASE_URL"
          echo "ğŸ“¦ Version URL: $VERSION_URL"
          echo "ğŸ”— Latest URL: $LATEST_URL"

      - name: Deployment info
        run: |
          BUCKET_NAME="${{ steps.bucket.outputs.name }}"
          VERSION="${{ steps.bucket.outputs.version }}"
          DEPLOY_TO_LATEST="${{ github.event.inputs.deploy_to_latest }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Frontend deployment completed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Application: ${{ github.event.inputs.app_name }}"
          echo "Bucket: $BUCKET_NAME"
          echo "Version: $VERSION"
          echo "Build output: ${{ github.event.inputs.build_output }}"
          echo ""
          echo "ğŸ“ URLs:"
          echo "   Version: ${{ steps.bucket_url.outputs.version_url }}"
          if [ "$DEPLOY_TO_LATEST" = "true" ]; then
            echo "   Latest:  ${{ steps.bucket_url.outputs.latest_url }}"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ’¡ Tips:"
          echo "   â€¢ Configure CDN to point to: v/latest/"
          echo "   â€¢ Use versioned URLs for testing: v/$VERSION/"
          echo "   â€¢ CDN console: https://console.cloud.yandex.ru/folders/${{ secrets.YC_FOLDER_ID }}/cdn/resource"
          echo ""
          echo "ğŸ“š Version history:"
          echo "   All versions are stored in: s3://$BUCKET_NAME/v/"

