name: Deploy to VM

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application name (e.g., backend)'
        required: true
        type: string
      image_tag:
        description: 'Image tag (leave empty to use commit SHA, first 8 chars)'
        required: false
        default: ''
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Build image tag
        id: image
        run: |
          APP_NAME="${{ github.event.inputs.app_name }}"
          
          if [ -z "${{ github.event.inputs.image_tag }}" ]; then
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ SHA ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ° (Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 8 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)
            COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
            IMAGE_TAG="$COMMIT_SHA"
          else
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞ³
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          fi
          
          IMAGE_FULL="cr.yandex/${{ secrets.YC_REGISTRY }}/$APP_NAME:$IMAGE_TAG"
          
          # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ¼Ñ VM: owner-or-org-appname
          REPO_OWNER="${{ github.repository_owner }}"
          VM_NAME="${REPO_OWNER}-${APP_NAME}"
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_FULL=$IMAGE_FULL" >> $GITHUB_ENV
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "VM_NAME=$VM_NAME" >> $GITHUB_ENV
          echo "ğŸ“¦ Deploying image: $IMAGE_FULL"
          echo "ğŸ–¥ï¸ VM name: $VM_NAME"

      - name: Deploy to VM
        uses: yc-actions/yc-coi-deploy@v2
        env:
          CR_REGISTRY: ${{ secrets.YC_REGISTRY }}
          CR_REPOSITORY: ${{ env.APP_NAME }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
          folder-id: ${{ secrets.YC_FOLDER_ID }}
          vm-name: ${{ env.VM_NAME }}
          vm-service-account-id: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          vm-cores: 2
          vm-memory: 4Gb
          vm-core-fraction: 100
          vm-subnet-id: ${{ secrets.YC_SUBNET_ID }}
          user-data-path: './.github/user-data-temp.yaml'
          docker-compose-path: './.github/docker-compose.yaml'

      - name: Update VM metadata with SSH key via API (optional)
        if: secrets.SSH_PUBLIC_KEY != ''
        run: |
          echo "ğŸ”‘ Updating VM metadata with SSH key via REST API..."
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ IAM Ñ‚Ğ¾ĞºĞµĞ½ Ğ¸Ğ· Service Account credentials
          SA_KEY='${{ secrets.YC_SA_JSON_CREDENTIALS }}'
          IAM_TOKEN=$(echo "$SA_KEY" | jq -r '.service_account_id // empty' | xargs -I {} sh -c 'curl -s -d "{\"yandexPassportOauthToken\":\"$(echo \"$SA_KEY\" | jq -r .oauth_token)\"}" "https://iam.api.cloud.yandex.net/iam/v1/tokens:exchange" | jq -r .iamToken' || echo "")
          
          # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¾ÑÑŒ Ñ‡ĞµÑ€ĞµĞ· oauth_token, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ñ‡ĞµÑ€ĞµĞ· id Ğ¸ private_key
          if [ -z "$IAM_TOKEN" ] || [ "$IAM_TOKEN" = "null" ]; then
            SA_ID=$(echo "$SA_KEY" | jq -r '.service_account_id // .id')
            SA_KEY_ID=$(echo "$SA_KEY" | jq -r '.id')
            PRIVATE_KEY=$(echo "$SA_KEY" | jq -r '.private_key')
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ JWT Ñ‚Ğ¾ĞºĞµĞ½ Ğ´Ğ»Ñ IAM
            JWT=$(echo "$SA_KEY" | jq -r '.private_key' | openssl dgst -sha256 -sign /dev/stdin <(echo -n "test") 2>/dev/null | base64 -w 0 || echo "")
            
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ IAM Ñ‚Ğ¾ĞºĞµĞ½ Ñ‡ĞµÑ€ĞµĞ· JWT
            IAM_TOKEN=$(curl -s -X POST "https://iam.api.cloud.yandex.net/iam/v1/tokens" \
              -H "Content-Type: application/json" \
              -d "{\"jwt\":\"$JWT\"}" | jq -r .iamToken || echo "")
          fi
          
          # Ğ•ÑĞ»Ğ¸ Ğ²ÑĞµ ĞµÑ‰Ğµ Ğ½ĞµÑ‚ Ñ‚Ğ¾ĞºĞµĞ½Ğ°, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ñ‡ĞµÑ€ĞµĞ· oauth
          if [ -z "$IAM_TOKEN" ] || [ "$IAM_TOKEN" = "null" ]; then
            echo "âš ï¸ Could not get IAM token, skipping metadata update"
            echo "SSH key will be applied via user-data only"
            exit 0
          fi
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ID VM Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸
          VM_NAME="${{ env.VM_NAME }}"
          FOLDER_ID="${{ secrets.YC_FOLDER_ID }}"
          
          VM_ID=$(curl -s -H "Authorization: Bearer $IAM_TOKEN" \
            "https://compute.api.cloud.yandex.net/compute/v1/instances?folderId=$FOLDER_ID" | \
            jq -r ".instances[] | select(.name == \"$VM_NAME\") | .id" | head -1)
          
          if [ -z "$VM_ID" ] || [ "$VM_ID" = "null" ]; then
            echo "âš ï¸ VM not found, skipping metadata update"
            exit 0
          fi
          
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ VM Ñ SSH ĞºĞ»ÑÑ‡Ğ¾Ğ¼
          SSH_KEY_VALUE="yc-user:${{ secrets.SSH_PUBLIC_KEY }}"
          
          curl -s -X POST "https://compute.api.cloud.yandex.net/compute/v1/instances/$VM_ID:updateMetadata" \
            -H "Authorization: Bearer $IAM_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"metadata\":{\"ssh-keys\":\"$SSH_KEY_VALUE\"}}" > /dev/null
          
          echo "âœ… VM metadata updated with SSH key via API"

      - name: Deployment info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment completed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Application: ${{ env.APP_NAME }}"
          echo "VM Name: ${{ env.VM_NAME }}"
          echo "Image: ${{ env.IMAGE_FULL }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

