name: Deploy to VM

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application name (e.g., backend)'
        required: true
        type: string
      image_tag:
        description: 'Image tag (leave empty to use commit SHA, first 8 chars)'
        required: false
        default: ''
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Build image tag
        id: image
        run: |
          APP_NAME="${{ github.event.inputs.app_name }}"
          
          if [ -z "${{ github.event.inputs.image_tag }}" ]; then
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ SHA ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ° (Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 8 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)
            COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
            IMAGE_TAG="$COMMIT_SHA"
          else
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞ³
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          fi
          
          IMAGE_FULL="cr.yandex/${{ secrets.YC_REGISTRY }}/$APP_NAME:$IMAGE_TAG"
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_FULL=$IMAGE_FULL" >> $GITHUB_ENV
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "ğŸ“¦ Deploying image: $IMAGE_FULL"

      - name: Prepare user-data with SSH key
        run: |
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ user-data Ñ SSH ĞºĞ»ÑÑ‡Ğ¾Ğ¼, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ ÑƒĞºĞ°Ğ·Ğ°Ğ½
          if [ -n "${{ secrets.SSH_PUBLIC_KEY }}" ]; then
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ¾Ğ¿Ğ¸Ñ user-data.yaml Ñ Ğ¿Ğ¾Ğ´ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¾Ğ¹ SSH ĞºĞ»ÑÑ‡Ğ°
            sed "s|SSH_PUBLIC_KEY_PLACEHOLDER|${{ secrets.SSH_PUBLIC_KEY }}|g" .github/user-data.yaml > .github/user-data-temp.yaml
            echo "âœ… SSH key added to user-data"
          else
            # Ğ•ÑĞ»Ğ¸ SSH ĞºĞ»ÑÑ‡ Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»
            cp .github/user-data.yaml .github/user-data-temp.yaml
            echo "âš ï¸ SSH_PUBLIC_KEY not found in secrets, using original user-data.yaml"
          fi

      - name: Deploy to VM
        uses: yc-actions/yc-coi-deploy@v2
        env:
          CR_REGISTRY: ${{ secrets.YC_REGISTRY }}
          CR_REPOSITORY: ${{ env.APP_NAME }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
          folder-id: ${{ secrets.YC_FOLDER_ID }}
          vm-name: ${{ env.APP_NAME }}-vm
          vm-service-account-id: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          vm-cores: 2
          vm-memory: 4Gb
          vm-core-fraction: 100
          vm-subnet-id: ${{ secrets.YC_SUBNET_ID }}
          user-data-path: './.github/user-data-temp.yaml'
          docker-compose-path: './.github/docker-compose.yaml'

      - name: Deployment info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment completed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Application: ${{ env.APP_NAME }}"
          echo "VM Name: ${{ env.APP_NAME }}-vm"
          echo "Image: ${{ env.IMAGE_FULL }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

