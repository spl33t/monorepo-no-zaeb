name: Deploy Frontend to Object Storage

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Frontend application name from apps/ directory (e.g., frontend)'
        required: true
        type: string
      bucket_name:
        description: 'Object Storage bucket name'
        required: false
        default: 'mv-dating'
        type: string
      build_command:
        description: 'Build command (default: npm run build)'
        required: false
        default: 'npm run build'
        type: string
      build_output:
        description: 'Build output directory (default: dist)'
        required: false
        default: 'dist'
        type: string

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Validate application exists
        run: |
          if [ ! -d "apps/${{ github.event.inputs.app_name }}" ]; then
            echo "âŒ Error: Application 'apps/${{ github.event.inputs.app_name }}' not found!"
            echo ""
            echo "Available applications:"
            ls -1 apps/ 2>/dev/null || echo "No apps directory found"
            exit 1
          fi
          
          echo "âœ… Application found: ${{ github.event.inputs.app_name }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¸Ğ· ĞºĞ¾Ñ€Ğ½Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° (Ğ´Ğ»Ñ monorepo)
          npm ci || npm install

      - name: Build frontend
        run: |
          cd apps/${{ github.event.inputs.app_name }}
          ${{ github.event.inputs.build_command }}
        env:
          NODE_ENV: production

      - name: Validate build output
        run: |
          BUILD_OUTPUT="${{ github.event.inputs.build_output }}"
          APP_DIR="apps/${{ github.event.inputs.app_name }}"
          
          if [ ! -d "$APP_DIR/$BUILD_OUTPUT" ]; then
            echo "âŒ Error: Build output directory '$BUILD_OUTPUT' not found in '$APP_DIR'"
            echo ""
            echo "Available directories:"
            ls -la "$APP_DIR" || echo "Directory not found"
            exit 1
          fi
          
          echo "âœ… Build output found: $APP_DIR/$BUILD_OUTPUT"

      - name: Build bucket name
        id: bucket
        run: |
          APP_NAME="${{ github.event.inputs.app_name }}"
          
          if [ -n "${{ github.event.inputs.bucket_name }}" ]; then
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ bucket
            BUCKET_NAME="${{ github.event.inputs.bucket_name }}"
          else
            # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ¼Ñ bucket: owner-reponame-appname
            REPO_OWNER="${{ github.repository_owner }}"
            REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
            BUCKET_NAME="${REPO_OWNER}-${REPO_NAME}-${APP_NAME}"
          fi
          
          echo "name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "ğŸŒ Bucket name: $BUCKET_NAME"

      - name: Upload files to Object Storage
        uses: yc-actions/yc-obj-storage-upload@v3
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
          bucket: ${{ steps.bucket.outputs.name }}
          root: apps/${{ github.event.inputs.app_name }}/${{ github.event.inputs.build_output }}
          include: |
            **/*

      - name: Set bucket URL
        id: bucket_url
        run: |
          BUCKET_NAME="${{ steps.bucket.outputs.name }}"
          BUCKET_URL="https://storage.yandexcloud.net/$BUCKET_NAME"
          
          echo "url=$BUCKET_URL" >> $GITHUB_OUTPUT
          echo "ğŸŒ Bucket URL: $BUCKET_URL"

      - name: Deployment info
        run: |
          BUCKET_NAME="${{ steps.bucket.outputs.name }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Frontend deployment completed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Application: ${{ github.event.inputs.app_name }}"
          echo "Bucket: $BUCKET_NAME"
          echo "Build output: ${{ github.event.inputs.build_output }}"
          echo "URL: ${{ steps.bucket_url.outputs.url }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ’¡ Tip: Configure CDN for better performance:"
          echo "   https://console.cloud.yandex.ru/folders/${{ secrets.YC_FOLDER_ID }}/cdn/resource"

