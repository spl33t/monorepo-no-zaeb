name: Deploy to Instance Group

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application name (e.g., backend)'
        required: true
        type: string
      image_tag:
        description: 'Image tag (leave empty to use commit SHA, first 8 chars)'
        required: false
        default: ''
        type: string
      instance_group_id:
        description: 'Instance Group ID (leave empty to use secret)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Yandex Cloud CLI
        run: |
          curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          export PATH="$HOME/.yandex-cloud/bin:$PATH"
          yc --version

      - name: Authenticate Yandex Cloud
        run: |
          export PATH="$HOME/.yandex-cloud/bin:$PATH"
          echo ${{ secrets.YC_OAUTH_TOKEN }} | yc auth login --token -

      - name: Determine Instance Group ID
        id: ig
        run: |
          if [ -n "${{ github.event.inputs.instance_group_id }}" ]; then
            IG_ID="${{ github.event.inputs.instance_group_id }}"
          else
            IG_ID="${{ secrets.YC_INSTANCE_GROUP_ID }}"
          fi
          
          if [ -z "$IG_ID" ]; then
            echo "‚ùå Instance Group ID not provided"
            echo "üí° Set YC_INSTANCE_GROUP_ID secret or provide instance_group_id input"
            exit 1
          fi
          
          echo "IG_ID=$IG_ID" >> $GITHUB_ENV
          echo "Using Instance Group: $IG_ID"

      - name: Build image tag
        run: |
          APP_NAME="${{ github.event.inputs.app_name }}"
          
          if [ -z "${{ github.event.inputs.image_tag }}" ]; then
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º SHA –∫–æ–º–º–∏—Ç–∞ (–ø–µ—Ä–≤—ã–µ 8 —Å–∏–º–≤–æ–ª–æ–≤)
            COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
            IMAGE_TAG="${{ secrets.YC_REGISTRY }}/$APP_NAME:$COMMIT_SHA"
          else
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ç–µ–≥
            IMAGE_TAG="${{ secrets.YC_REGISTRY }}/$APP_NAME:${{ github.event.inputs.image_tag }}"
          fi
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "üì¶ Deploying image: $IMAGE_TAG"

      - name: Update Instance Group
        run: |
          export PATH="$HOME/.yandex-cloud/bin:$PATH"
          
          echo "üîÑ Updating Instance Group: $IG_ID"
          echo "üì¶ New image: $IMAGE_TAG"
          
          # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–±—Ä–∞–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
          yc compute instance-group update $IG_ID \
            --template-container-image=$IMAGE_TAG
          
          echo "‚úÖ Instance Group update initiated!"
          echo "üí° Instance Group will perform rolling update automatically"

      - name: Wait for update to complete
        run: |
          export PATH="$HOME/.yandex-cloud/bin:$PATH"
          
          echo "‚è≥ Waiting for Instance Group update to complete..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          OPERATION_ID=$(yc compute instance-group list-operations $IG_ID --limit=1 --format=json | jq -r '.[0].id')
          
          if [ -n "$OPERATION_ID" ] && [ "$OPERATION_ID" != "null" ]; then
            echo "üìä Operation ID: $OPERATION_ID"
            yc operation wait $OPERATION_ID --timeout=600
            echo "‚úÖ Update completed successfully!"
          else
            echo "‚ÑπÔ∏è  Could not track operation, but update was initiated"
          fi

      - name: Deployment info
        run: |
          echo "‚úÖ Deployment completed!"
          echo "Instance Group: $IG_ID"
          echo "Image: $IMAGE_TAG"
          echo ""
          echo "üìä Check status:"
          echo "yc compute instance-group get $IG_ID"

