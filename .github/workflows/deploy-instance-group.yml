name: Deploy to Instance Group

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application name (e.g., backend)'
        required: true
        type: string
      image_tag:
        description: 'Image tag (leave empty to use commit SHA, first 8 chars)'
        required: false
        default: ''
        type: string
      port:
        description: 'Application port (default: 3333)'
        required: false
        default: '3333'
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Build image tag
        id: image
        run: |
          APP_NAME="${{ github.event.inputs.app_name }}"
          
          # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°: owner-reponame-appname
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          IMAGE_NAME="${REPO_OWNER}-${REPO_NAME}-${APP_NAME}"
          
          if [ -z "${{ github.event.inputs.image_tag }}" ]; then
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ SHA ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ° (Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 8 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)
            COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
            IMAGE_TAG="$COMMIT_SHA"
          else
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞ³
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          fi
          
          IMAGE_FULL="cr.yandex/${{ secrets.YC_REGISTRY }}/$IMAGE_NAME:$IMAGE_TAG"
          
          # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ¼Ñ Instance Group: owner-reponame-appname-ig
          IG_NAME="${REPO_OWNER}-${REPO_NAME}-${APP_NAME}-ig"
          
          if [ -z "${{ github.event.inputs.port }}" ]; then
            PORT="3333"
          else
            PORT="${{ github.event.inputs.port }}"
          fi
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_FULL=$IMAGE_FULL" >> $GITHUB_ENV
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "IG_NAME=$IG_NAME" >> $GITHUB_ENV
          echo "PORT=$PORT" >> $GITHUB_ENV
          echo "ğŸ“¦ Deploying image: $IMAGE_FULL"
          echo "ğŸ–¥ï¸ Instance Group name: $IG_NAME"
          echo "ğŸ”Œ Using port: $PORT"

      - name: Deploy to Instance Group
        uses: yc-actions/yc-coi-deploy-ig@v2
        env:
          CR_REGISTRY: ${{ secrets.YC_REGISTRY }}
          CR_REPOSITORY: ${{ env.IMAGE_NAME }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          IG_NAME: ${{ env.IG_NAME }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          YC_NETWORK_ID: ${{ secrets.YC_NETWORK_ID }}
          YC_SUBNET_ID: ${{ secrets.YC_SUBNET_ID }}
          SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
          PORT: ${{ env.PORT }}
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
          folder-id: ${{ secrets.YC_FOLDER_ID }}
          ig-spec-path: './.github/instance-group-spec.yaml'
          user-data-path: './.github/user-data.yaml'
          docker-compose-path: './.github/docker-compose.yaml'

      - name: Deployment info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment completed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Application: ${{ env.APP_NAME }}"
          echo "Instance Group: ${{ env.IG_NAME }}"
          echo "Image: ${{ env.IMAGE_FULL }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

